# getSecurePorts_final.py
# Usage:
#   wsadmin.sh -lang jython \
#     -conntype SOAP -host <dmgrHost> -port <dmgrPort> \
#     -f getSecurePorts_final.py

import java

sep = java.lang.System.getProperty('line.separator')

# 1. Get the cell name
cells = AdminConfig.list('Cell').splitlines()
if not cells:
    raise Exception("No Cell found; check connection parameters")
cellName = AdminConfig.showAttribute(cells[0], 'name')

# 2. Iterate each node and server
for nodeId in AdminConfig.list('Node').splitlines():
    nodeName = AdminConfig.showAttribute(nodeId, 'name')
    for srvId in AdminConfig.list('Server', nodeId).splitlines():
        srvName = srvId.split('(')[0]

        # 3. List ports using PortManagement API
        raw = AdminTask.listServerPorts('[-serverName %s -nodeName %s]' % (srvName, nodeName))
        for line in raw.split(sep):
            parts = line.split()
            # 4. Filter for secure HTTP endpoint
            if len(parts) == 3 and parts[0] == 'WC_defaulthost_secure':
                host = parts[1]
                port = parts[2]
                # 5. Output: cellName nodeName serverName host port
                print "%s %s %s %s %s" % (cellName, nodeName, srvName, host, port)
                break
