# getSecurePorts_final.py
# Usage:
#   wsadmin.sh -lang jython \
#     -conntype SOAP -host <dmgrHost> -port <dmgrPort> \
#     -f getSecurePorts_final.py

import java

# Java line separator
sep = java.lang.System.getProperty('line.separator')

# 1. Retrieve cell name
cells   = AdminConfig.list('Cell').splitlines()
cellId  = cells[0] if cells else None
cellName = AdminConfig.showAttribute(cellId, 'name') if cellId else 'UNKNOWN'

# 2. Iterate each node and its servers
for nodeId in AdminConfig.list('Node').splitlines():
    nodeName = AdminConfig.showAttribute(nodeId, 'name')
    for srvId in AdminConfig.list('Server', nodeId).splitlines():
        srvName = srvId.split('(')[0]

        # 3. Correct listServerPorts invocation
        raw = AdminTask.listServerPorts(srvName, '[-nodeName %s]' % nodeName)

        # 4. Parse and filter for secure endpoint
        for line in raw.split(sep):
            parts = line.split()
            # Expect: [nodeName, serverName, endPointName, host, port]
            if len(parts) >= 5 and parts[2] == 'WC_defaulthost_secure':
                host = parts[3]
                port = parts[4]
                print "%s %s %s %s %s" % (
                    cellName, nodeName, srvName, host, port)
                break
