# getSecurePorts_final.py
# wsadmin Jython (Python 2.7) script to list WC_defaulthost_secure ports with real hostnames
# Usage:
#   wsadmin.sh -lang jython \
#     -conntype SOAP -host <dmgrHost> -port <dmgrPort> \
#     -f getSecurePorts_final.py

import java

# Java line separator for splitting list() results
sep = java.lang.System.getProperty('line.separator')

# 1. Get the cell name
cell_ids = AdminConfig.list('Cell').splitlines()
if not cell_ids:
    raise Exception("No Cell found; check your connection parameters")
cellId   = cell_ids[0]
cellName = AdminConfig.showAttribute(cellId, 'name')

# 2. Iterate all ServerEntry objects (includes app servers + dmgr)
for srvEntry in AdminConfig.list('ServerEntry').splitlines():
    # ServerEntry ID looks like:
    #   serverName(cells/CellA/nodes/Node01/servers/serverName|server.xml#ServerEntry_...)
    srvName = srvEntry.split('(', 1)[0]

    # 3. Extract the node name from the config path
    try:
        nodeName = srvEntry.split('/nodes/')[1].split('/')[0]
    except IndexError:
        # skip entries that don't match expected pattern
        continue

    # 4. Lookup the Node config to get its real hostName
    nodeId = AdminConfig.getid('/Node:%s/' % nodeName)
    if nodeId:
        hostName = AdminConfig.showAttribute(nodeId, 'hostName')
    else:
        hostName = 'UNKNOWN'

    # 5. Find the WC_defaulthost_secure NamedEndPoint under this ServerEntry
    for nep in AdminConfig.list('NamedEndPoint', srvEntry).split(sep):
        if not nep.strip():
            continue
        if AdminConfig.showAttribute(nep, 'endPointName') == 'WC_defaulthost_secure':
            # port from the NamedEndPoint
            port = AdminConfig.showAttribute(nep, 'port')
            # Print: cellName nodeName serverName hostName port
            print "%s %s %s %s %s" % (
                cellName, nodeName, srvName, hostName, port)
            break
