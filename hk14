1) Update the task to build a render context

Replace your report_only.yml middle section with this (keep the “collect precheck data” step):

- name: report_only | collect precheck data
  set_fact:
    precheck_data: "{{ hostvars['localhost'][pipeline_stats_var].precheck | default({}) }}"
  run_once: true
  delegate_to: localhost

# Summary counts (unchanged)
- name: report_only | compute summary counts
  set_fact:
    dr_total_scanned: "{{ precheck_data | length }}"
    dr_need_count: >-
      {{ (precheck_data | dict2items
          | selectattr('value.status','equalto','need to renew')
          | list | length) }}
    dr_expiring_count: >-
      {{ (precheck_data | dict2items
          | selectattr('value.status','equalto','expiring')
          | list | length) }}
    dr_noneed_count: >-
      {{ (precheck_data | dict2items
          | selectattr('value.status','equalto','no renewal needed')
          | list | length) }}
  run_once: true
  delegate_to: localhost

# NEW: Build Outlook-safe render context for the template
- name: report_only | build render context
  set_fact:
    __report_pre: "{{ precheck_data | default({}) }}"
    __report_total: "{{ dr_total_scanned | default((precheck_data | default({})) | length) }}"
    __report_need: "{{ dr_need_count | default(0) }}"
    __report_expiring: "{{ dr_expiring_count | default(0) }}"
    __report_noneed: "{{ dr_noneed_count | default(0) }}"
    __report_logo: "{{ report_logo_url | default('') }}"
  run_once: true
  delegate_to: localhost

- name: report_only | build html
  template:
    src: report_dry.html.j2
    dest: "/tmp/venafi_report_dry.html"
  run_once: true
  delegate_to: localhost


This guarantees all variables your template needs are already defined—no {% set %} needed.

2) Replace the template (no {% set %} at all)

Use this Outlook-friendly, full-width, blue theme with a left logo. It reads only the __report_* variables we prepared.

templates/report_dry.html.j2
<!doctype html>
<html>
  <head>
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>Venafi Precheck Dry-Run</title>
    <!--[if !mso]><!-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<![endif]-->
  </head>
  <body style="margin:0; padding:0; background:#f2f6fb;">
    <!-- Full-width wrapper -->
    <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="background:#f2f6fb; margin:0; padding:0;">
      <!-- Header bar (full width) -->
      <tr>
        <td style="background:#0b63c4; background-image:linear-gradient(90deg,#0b63c4,#1985e2); padding:16px;">
          <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%">
            <tr>
              <!-- Logo (left) -->
              <td valign="middle" style="padding-right:12px; white-space:nowrap; width:44px;">
                {% if __report_logo %}
                <img src="{{ __report_logo }}" alt="Logo" width="36" height="36" style="display:inline-block; border:0; outline:none; text-decoration:none; width:36px; height:36px; vertical-align:middle; border-radius:4px;">
                {% endif %}
              </td>
              <!-- Title -->
              <td valign="middle" style="padding:0;">
                <div style="font-family:Segoe UI, Arial, sans-serif; font-size:20px; line-height:24px; color:#ffffff; font-weight:700;">
                  Venafi Precheck <span style="opacity:.9; font-weight:600;">Dry-Run Report</span>
                </div>
                <div style="margin-top:4px; font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#eaf3ff; opacity:.95;">
                  Generated: {{ ansible_date_time.date }} {{ ansible_date_time.time }} &nbsp;|&nbsp; Pipeline: {{ pipeline_stats_var }}
                </div>
              </td>
            </tr>
          </table>
        </td>
      </tr>

      <!-- Summary row (full width) -->
      <tr>
        <td style="padding:12px 16px 4px 16px;">
          <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%">
            <tr>
              <!-- Card 1 -->
              <td valign="top" style="padding:8px;">
                <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border:1px solid #e3eaf5; border-radius:6px; background:#ffffff;">
                  <tr><td style="padding:12px;">
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#3a5a8f; text-transform:uppercase; letter-spacing:.02em;">Total Scanned</div>
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:24px; color:#0b63c4; font-weight:700; margin-top:2px;">{{ __report_total }}</div>
                  </td></tr>
                </table>
              </td>
              <!-- Card 2 -->
              <td valign="top" style="padding:8px;">
                <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border:1px solid #e3eaf5; border-radius:6px; background:#ffffff;">
                  <tr><td style="padding:12px;">
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#3a5a8f; text-transform:uppercase; letter-spacing:.02em;">Needs Renewal</div>
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:24px; color:#c62828; font-weight:700; margin-top:2px;">{{ __report_need }}</div>
                  </td></tr>
                </table>
              </td>
              <!-- Card 3 -->
              <td valign="top" style="padding:8px;">
                <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border:1px solid #e3eaf5; border-radius:6px; background:#ffffff;">
                  <tr><td style="padding:12px;">
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#3a5a8f; text-transform:uppercase; letter-spacing:.02em;">Expiring</div>
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:24px; color:#f9a825; font-weight:700; margin-top:2px;">{{ __report_expiring }}</div>
                  </td></tr>
                </table>
              </td>
              <!-- Card 4 -->
              <td valign="top" style="padding:8px;">
                <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border:1px solid #e3eaf5; border-radius:6px; background:#ffffff;">
                  <tr><td style="padding:12px;">
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#3a5a8f; text-transform:uppercase; letter-spacing:.02em;">No Renewal Needed</div>
                    <div style="font-family:Segoe UI, Arial, sans-serif; font-size:24px; color:#2e7d32; font-weight:700; margin-top:2px;">{{ __report_noneed }}</div>
                  </td></tr>
                </table>
              </td>
            </tr>
          </table>
          <div style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#5275a5; margin:4px 8px 0 8px;">
            Thresholds: need ≤ {{ threshold_need_renew_days | int }}, expiring ≤ {{ threshold_no_renew_needed | int }} (gap-free bands)
          </div>
        </td>
      </tr>

      <!-- Details (full width) -->
      <tr>
        <td style="padding:8px 16px 20px 16px;">
          <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border:1px solid #d6e3f7; border-radius:6px; background:#ffffff;">
            <tr>
              <td colspan="5" style="background:#e8f1fd; padding:10px 12px; border-bottom:1px solid #d6e3f7;">
                <div style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; font-weight:700; color:#234d86;">
                  Certificate Details
                </div>
              </td>
            </tr>
            <tr>
              <th align="left" style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#234d86; background:#f4f8ff; padding:10px; border-bottom:1px solid #e3eaf5;">Cert</th>
              <th align="left" style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#234d86; background:#f4f8ff; padding:10px; border-bottom:1px solid #e3eaf5;">Pickup ID</th>
              <th align="left" style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#234d86; background:#f4f8ff; padding:10px; border-bottom:1px solid #e3eaf5;">Status</th>
              <th align="left" style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#234d86; background:#f4f8ff; padding:10px; border-bottom:1px solid #e3eaf5;">Serial</th>
              <th align="left" style="font-family:Segoe UI, Arial, sans-serif; font-size:12px; color:#234d86; background:#f4f8ff; padding:10px; border-bottom:1px solid #e3eaf5;">Expiry (days)</th>
            </tr>
            {% for cert_name, data in __report_pre.items() %}
            {% set status = data.status | default('') %}
            {% set status_color = '#2e7d32' if status == 'no renewal needed' else ('#f9a825' if status == 'expiring' else '#c62828') %}
            <tr>
              <td style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; color:#1c2a3a; padding:10px; border-bottom:1px solid #eef3fb;">{{ cert_name }}</td>
              <td style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; color:#1c2a3a; padding:10px; border-bottom:1px solid #eef3fb;">{{ data.pickup_id }}</td>
              <td style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; color:{{ status_color }}; font-weight:600; padding:10px; border-bottom:1px solid #eef3fb;">{{ status }}</td>
              <td style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; color:#1c2a3a; padding:10px; border-bottom:1px solid #eef3fb;">{{ data.serial }}</td>
              <td style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; color:#1c2a3a; padding:10px; border-bottom:1px solid #eef3fb;">{{ data.expiry_days | default('N/A') }}</td>
            </tr>
            {% endfor %}
            {% if __report_pre|length == 0 %}
            <tr>
              <td colspan="5" style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; color:#5a6c86; padding:14px; text-align:center;">
                No certificates were found to report.
              </td>
            </tr>
            {% endif %}
          </table>

          <!-- Footer note -->
          <div style="font-family:Segoe UI, Arial, sans-serif; font-size:11px; color:#6f86ad; margin-top:10px;">
            Run at {{ pipeline_now }}
          </div>
        </td>
      </tr>

      <!-- Bottom spacer -->
      <tr>
        <td style="height:16px; line-height:16px; font-size:0;">&nbsp;</td>
      </tr>
    </table>
  </body>
</html>

Why this fixes it

No {% set %} in the template → avoids Jinja scoping/undefined pitfalls in Ansible 2.9.

All values are computed in tasks and injected as plain variables.

Still fully Outlook-friendly, full-width, blue theme, with logo on the left if report_logo_url is set.

If you also want the same treatment for the renew report template, I can hand you a matching report_renew.html.j2.

ChatGPT can make mistakes. Check important info.
