- name: Test TCP connectivity via telnet
  hosts: db
  gather_facts: no
  vars:
    port: 5432

  tasks:
    - name: Telnet to {{ inventory_hostname }}:{{ port }}
      ansible.builtin.shell: |
        timeout 5 telnet {{ inventory_hostname }} {{ port }} </dev/null 2>&1 \
          && echo "CONNECTED" || echo "FAILED"
      register: telnet_check
      changed_when: false

    - name: Show telnet result
      ansible.builtin.debug:
        msg: "Port {{ port }} on {{ inventory_hostname }} is {{ telnet_check.stdout }}"
      failed_when: telnet_check.stdout != "CONNECTED"
