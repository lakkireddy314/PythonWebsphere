---
- name: "Initialize cert expiry result dictionary"
  set_fact:
    cert_days_remaining_per_alias: {}
  tags:
    - precheck
    - expiry-check

- name: "Check certificate expiry and serial for each alias"
  block:
    - name: "Get expiry date of cert {{ pickup_entry.value }}"
      shell: |
        openssl x509 -enddate -noout -in {{ vcert_install_dir }}/{{ pickup_entry.value }}.pem | cut -d= -f2
      register: cert_expiry_raw
      changed_when: false
      delegate_to: localhost

    - name: "Get serial number of cert {{ pickup_entry.value }}"
      shell: |
        openssl x509 -in {{ vcert_install_dir }}/{{ pickup_entry.value }}.pem -serial -noout | cut -d= -f2
      register: cert_serial_raw
      changed_when: false
      delegate_to: localhost

    - name: "Calculate days until expiry for {{ pickup_entry.value }}"
      set_fact:
        cert_days_remaining_per_alias: >-
          {{
            cert_days_remaining_per_alias |
            combine({ pickup_entry.value:
              (
                (
                  cert_expiry_raw.stdout | to_datetime('%b %d %H:%M:%S %Y %Z')
                ).timestamp()
                -
                (
                  ansible_date_time.iso8601 | to_datetime
                ).timestamp()
              ) / 86400 | round(0, 'floor') | int })
          }}
      when: cert_expiry_raw.stdout is defined
      tags:
        - precheck
        - expiry-check

    - name: "Set local cert info for alias {{ pickup_entry.value }}"
      set_fact:
        local_cert_info: >-
          {{
            local_cert_info | default({}) | combine({
              pickup_entry.value: {
                "serial": cert_serial_raw.stdout,
                "expiry_days": cert_days_remaining_per_alias[pickup_entry.value],
                "changed": (cert_days_remaining_per_alias[pickup_entry.value] <= cert_renew_threshold)
              }
            })
          }}
      when: cert_days_remaining_per_alias[pickup_entry.value] is defined
      tags:
        - precheck
        - expiry-check

    - name: "DEBUG summary for {{ pickup_entry.value }}"
      debug:
        msg: >-
          Alias {{ pickup_entry.value }} expires in {{ cert_days_remaining_per_alias[pickup_entry.value] }} days.
          Serial: {{ cert_serial_raw.stdout }}.
          Renewal needed: {{ local_cert_info[pickup_entry.value].changed }}
      when: cert_days_remaining_per_alias[pickup_entry.value] is defined
      tags:
        - precheck
        - expiry-check

  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: pickup_entry
    label: "{{ pickup_entry.key }}"
  tags:
    - precheck
    - expiry-check
