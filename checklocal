---

- name: "Initialize expiry tracking"
  set_fact:
    cert_days_remaining_per_alias: {}
    local_cert_info: {}
  tags:
    - precheck
    - expiry-check

- name: "Fetch expiry date for each cert alias"
  shell: >
    openssl x509 -enddate -noout
      -in {{ vcert_install_dir }}/{{ alias_entry.value }}.pem
    | cut -d= -f2
  register: expiry_result
  changed_when: false
  delegate_to: localhost
  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: alias_entry
    label: "{{ alias_entry.key }}"
  tags:
    - precheck
    - expiry-check

- name: "Fetch serial number for each cert alias"
  shell: >
    openssl x509 -in {{ vcert_install_dir }}/{{ alias_entry.value }}.pem
      -serial -noout
    | cut -d= -f2
  register: serial_result
  changed_when: false
  delegate_to: localhost
  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: alias_entry
    label: "{{ alias_entry.key }}"
  tags:
    - precheck
    - expiry-check

- name: "Compute days until expiry for each alias"
  set_fact:
    cert_days_remaining_per_alias: >-
      {{
        cert_days_remaining_per_alias | combine({
          alias_entry.value: (
            (
              expiry_result.results[ansible_loop.index0].stdout
              | default('')
              | to_datetime('%b %d %H:%M:%S %Y %Z')
            ).timestamp()
            -
            (ansible_date_time.iso8601 | to_datetime).timestamp()
          ) / 86400 | round(0, 'floor') | int
        })
      }}
  when: expiry_result.results[ansible_loop.index0].stdout is defined
  delegate_to: localhost
  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: alias_entry
  tags:
    - precheck
    - expiry-check

- name: "Set local_cert_info per alias"
  set_fact:
    local_cert_info: >-
      {{
        local_cert_info | combine({
          alias_entry.value: {
            "serial": serial_result.results[ansible_loop.index0].stdout | default('UNKNOWN'),
            "expiry_days": cert_days_remaining_per_alias[alias_entry.value],
            "changed": cert_days_remaining_per_alias[alias_entry.value] <= cert_renew_threshold
          }
        })
      }}
  when:
    - cert_days_remaining_per_alias[alias_entry.value] is defined
    - serial_result.results[ansible_loop.index0].stdout is defined
  delegate_to: localhost
  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: alias_entry
  tags:
    - precheck
    - expiry-check

- name: "Debug certificate status summary"
  debug:
    msg: >-
      Alias {{ alias_entry.value }}:
      expires in {{ cert_days_remaining_per_alias[alias_entry.value] }} days,
      serial {{ local_cert_info[alias_entry.value].serial }},
      needs_renewal={{ local_cert_info[alias_entry.value].changed }}
  when: cert_days_remaining_per_alias[alias_entry.value] is defined
  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: alias_entry
  tags:
    - precheck
    - expiry-check
