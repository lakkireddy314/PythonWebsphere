Here’s the correct way to split your expiry‐check so that:

No delegate_to appears on the include_tasks itself

All delegation happens inside the included file on each task

1. tasks/check_local_cert.yml
yaml
Copy
---
- name: "Initialize expiry tracking"
  set_fact:
    local_cert_info: {}
  tags:
    - precheck
    - expiry-check

- name: "Check expiry & serial for each cert alias"
  include_tasks: check_one_cert.yml
  loop: "{{ httpd_pickup_ids | dict2items }}"
  loop_control:
    loop_var: alias_entry
    label: "{{ alias_entry.key }}"
  tags:
    - precheck
    - expiry-check
Note: No delegate_to here—this just drives the loop and includes the helper.

2. tasks/check_one_cert.yml
yaml
Copy
---
- name: "Fetch expiry date for alias {{ alias_entry.value }}"
  shell: >
    openssl x509 -enddate -noout
      -in {{ vcert_install_dir }}/{{ alias_entry.value }}.pem
    | cut -d= -f2
  register: expiry_result
  changed_when: false
  delegate_to: localhost
  tags:
    - precheck
    - expiry-check

- name: "Fetch serial number for alias {{ alias_entry.value }}"
  shell: >
    openssl x509 -in {{ vcert_install_dir }}/{{ alias_entry.value }}.pem
      -serial -noout | cut -d= -f2
  register: serial_result
  changed_when: false
  delegate_to: localhost
  tags:
    - precheck
    - expiry-check

- name: "Parse expiry timestamp for alias {{ alias_entry.value }}"
  set_fact:
    expiry_ts: "{{ expiry_result.stdout | to_datetime('%b %d %H:%M:%S %Y %Z') }}"
  delegate_to: localhost
  tags:
    - precheck
    - expiry-check

- name: "Compute days until expiry for alias {{ alias_entry.value }}"
  set_fact:
    days_rem: >-
      {{
        (
          expiry_ts.timestamp()
          -
          (ansible_date_time.iso8601 | to_datetime).timestamp()
        ) / 86400 | round(0, 'floor') | int
      }}
  delegate_to: localhost
  tags:
    - precheck
    - expiry-check

- name: "Record cert info for alias {{ alias_entry.value }}"
  set_fact:
    local_cert_info: >-
      {{ local_cert_info 
         | combine({ alias_entry.value: {
             serial:      serial_result.stdout,
             expiry_days: days_rem,
             changed:     (days_rem <= cert_renew_threshold)
           }}) }}
  delegate_to: localhost
  tags:
    - precheck
    - expiry-check

- name: "Debug summary for alias {{ alias_entry.value }}"
  debug:
    msg: >-
      Alias {{ alias_entry.value }}:
        expires in {{ days_rem }} days,
        serial={{ serial_result.stdout }},
        needs_renewal={{ days_rem <= cert_renew_threshold }}
  delegate_to: localhost
  tags:
    - precheck
    - expiry-check
